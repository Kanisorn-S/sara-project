\documentclass[12pt,a4paper]{article}

% Packages
\usepackage{amsmath, amssymb}
\usepackage{graphicx}
\usepackage{siunitx} 
\usepackage{caption}
\usepackage{geometry}
\usepackage{hyperref}
\usepackage{url}
\usepackage{cite}
\usepackage{listings}
\usepackage{listings-rust}
\usepackage{xurl}
\usepackage{siunitx}
\usepackage{tikz}

\lstset{language=Rust, style=boxed}
\geometry{margin=1in}
\graphicspath{{/images}}

\title{Sensors and Actuators for Robotics and
Automation\\Term Project Progress Report IV}
\author{Kanisorn Sangchai (ID: 6538020621)}
\date{November 17, 2025}

\begin{document}

\maketitle

\section{Introduction}
This report presents the fourth progress update for the temperature control and sensing system using an adjustable voltage divider and thermistor. Building upon the previous milestone, this stage focuses on implementing a Proportional–Integral (PI) controller on the STM32H743VIT6 Core Board by WeAct Studio to achieve automatic temperature regulation. The controller dynamically adjusts the digital potentiometer (MCP41010) value to maintain the measured temperature at the desired target, providing both fast response and steady-state accuracy. 


\begin{figure}[h]
    \centering
    \includegraphics[width=0.9\textwidth]{images/circuit_diagram.png}
    \caption{Circuit diagram of a temperature control and sensing system using an adjustable voltage divider and thermistor.}
    \label{fig:circuit}
\end{figure}

\section{Circuit Design}
The circuit design remains the same as in the previous milestone, as shown in Figure~\ref{fig:circuit}. 


\section{PI Controller Implementation}
\label{sec:pi-controller}

\subsection{Mathematical Model}

\subsubsection{Controller Design}

To achieve stable and accurate temperature control, we implemented a Proportional–Integral (PI) controller on the STM32H743VIT6 Core Board. The objective of the controller is to automatically adjust the system’s potentiometer value $\text{pot\_value}$ such that the measured temperature $T_{\text{measured}}$ matches the desired temperature $T_{\text{goal}}$.

The PI controller computes a control signal $u(t)$ based on the instantaneous temperature error
\begin{equation}
    e(t) = T_{\text{goal}} - T_{\text{measured}}
    \label{eq:pi-error}
\end{equation}
and the accumulation of past errors. The controller output is given by
\begin{equation}
    u(t) = K_P e(t) + K_I \int_0^t e(\tau)\, d\tau
    \label{eq:pi-eq}
\end{equation}
where $K_P$ and $K_I$ are the proportional and integral gains, respectively.

The proportional term $K_P e(t)$ provides an immediate correction proportional to the current error, giving the system fast response. The integral term $K_I \int e(t)\,dt$ eliminates the steady-state error by accumulating the past deviation from the target temperature, ensuring the system converges exactly to $T_{\text{set}}$ over time.

\subsubsection{Discretization}

Because the STM32 executes in discrete time steps, Equation~\eqref{eq:pi-eq} is implemented in its discrete form:
\begin{equation}
    u[k] = K_P e[k] + K_I \sum_{i=0}^{k} e[i] \Delta t
    \label{eq:pi-discrete}
\end{equation}
where $u[k]$ is the controller output at discrete time index $k$, and $\Delta t$ is the sampling interval.

The controller then updates the potentiometer value $\text{pot\_value}$ as:
\begin{equation}
    \text{pot\_value}_{\text{new}} = \text{POT\_VALUE} - u[k]
    \label{eq:pot-update}
\end{equation}
The subtraction in Equation~\eqref{eq:pot-update} ensures negative feedback: when the temperature is below the target (positive error), $u[k]$ becomes positive, thus decreasing $\text{pot\_value}$ to increase the heater voltage and raise the temperature. Conversely, when the temperature exceeds the target (negative error), $u[k]$ becomes negative, increasing $\text{pot\_value}$ to lower the heater voltage and reduce the temperature.

\subsection{Implementation}

\subsubsection{Code Integration}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.3\textwidth]{images/main_control_flow.png}
    \caption{Flowchart of the main control and sensing loop integrating the PI controller.}
    \label{fig:main-control-flow}
\end{figure}

The PI controller was implemented in Rust and integrated into the main control and sensing loop, as shown in Listing~\ref{lst:pi-controller}. The control and sensing loop reads the measured temperature, compute the control signal, and update the digital potentiometer value following the flow shown in Figure~\ref{fig:main-control-flow}.

\begin{lstlisting}[caption={PI Controller Implementation in Rust}, label={lst:pi-controller}]
let mut integral: f32 = 0.0;
const KP: f32 = 0.8;
const KI: f32 = 0.02;
let mut pot_value: f32 = 0f32;

// Main control loop
loop {
    // 1. Get the current temperature from our 
    temperature sensor and Kalman filter
    let data: u32 = adc1.read(&mut channel).unwrap();

    // Kalman filter ...

    x_e = x_p + (K * (z - x_p));

    // 2. Compute instantaneous error
    let error = TARGET_TEMP - current_temp;

    // 3. Update integral term 
    integral += error * SAMPLE_PERIOD;

    // 4. Compute PI control output
    let control_signal = KP * error + KI * integral;

    // 5. Update potentiometer value 
    pot_value = POT_VALUE_MAX - control_signal;
    pot_value = pot_value.clamp(0.0, 255.0);

    // 6. Send the new value to MCP41010 
    mcp41x.set_position(Channel::Ch0, pot_value).unwrap();

    delay_ms(SAMPLE_PERIOD_MS);
}
\end{lstlisting}

The proportional term provides an immediate correction based on the present temperature error, while the integral term accumulates the past errors to eliminate long-term bias. The subtraction in the potentiometer update ensures proper negative feedback: when the measured temperature is below the target, the controller reduces the potentiometer value, increasing heater power to raise the temperature.  

\subsubsection{Tuning}

The controller gains $K_P$ and $K_I$ were determined experimentally through trial and error.

\paragraph{Step 1: Determine the Proportional Gain.}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.7\textwidth]{images/on_off.jpg}
    \caption{System output oscillating with high proportional gain, resembling an on-off controller.}
    \label{fig:on-off}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.7\textwidth]{images/steady_state.jpg}
    \caption{System output reaching a steady state error with reduced proportional gain.}
    \label{fig:steady-state}
\end{figure}

First, the integral term was disabled ($K_I = 0$), and the proportional gain $K_P$ was gradually increased until the system output began to oscillate, essentially becoming an on-off controller, as shown in Figure~\ref{fig:on-off}. The proportional gain is then lowered until we get a steady state error, as shown in Figure~\ref{fig:steady-state}.

From the experiment, our PI controller began to oscillate at:
\begin{align*}
    K_P &= 2100.0 \\
\end{align*}

Therefore, we lowered $K_P$ to:
\begin{align*}
    K_P &= 1850.0
\end{align*}

\paragraph{Step 2: Determine the Integral Gain.}
After setting $K_P=1850.0$, we enabled the integral term and gradually increased $K_I$ until the steady-state error was eliminated, and the system reached the target temperature without oscillation. 

From the experiment, the integral gain was set to:
\begin{align*}
    K_I &= 5.0
\end{align*}

\paragraph{Step 3: Validation and Fine-Tuning.}
After applying these initial parameters, the system was tested under various target temperature settings. Small manual adjustments were made to slightly reduce $K_P$ (to 1.0) and $K_I$ (to 0.09) to minimize overshoot and improve stability without increasing settling time.

The final controller parameters were:
\begin{align*}
    K_P &= 1.0 \\
    K_I &= 0.09
\end{align*}


\section{Demonstration and Verification}
To verify the effectiveness of the PI controller, a series of tests were conducted where the target temperature was set to various values. The system's response was monitored to assess whether it could reach and maintain the desired temperature. 

The experiment was set up as follows:
\begin{itemize}
    \item The ambient temperature was approximately \SI{25.8}{\celsius}.
    \item The target temperature was set to \SI{25.9}{\celsius}, \SI{26.0}{\celsius}, and \SI{26.1}{\celsius} in separate trials.
\end{itemize}

The results showed that the PI controller successfully regulated the temperature with minimal overshoot and steady-state error, demonstrating the effectiveness of the implemented control strategy.

\section{Conclusion}
The PI controller was successfully implemented on the STM32H743VIT6 Core Board to achieve stable and accurate temperature control. The controller continuously adjusted the digital potentiometer value to maintain the thermistor’s temperature near the target with minimal overshoot and steady-state error. The implementation and testing stages demonstrated:
\begin{itemize}
    \item Successful integration of a discrete-time PI controller with the existing sensing and actuation loop
    \item Gain tuning using the Ziegler–Nichols closed-loop method
    \item Validation of the controller through temperature tracking experiments
    \item Demonstration of precise temperature regulation with improved response stability
\end{itemize}

\end{document}